(()=>{console.log("Flow Mate Content Script Loaded");let t=null,e=null,n=0,o=[];const r=document.createElement("style");function i(t,e){const n=document.caretRangeFromPoint(t,e);if(!n)return-1;const o=n.startContainer;if(o.nodeType!==Node.TEXT_NODE)return-1;const r=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(t){const e=t.parentElement;if(!e)return NodeFilter.FILTER_REJECT;const n=e.tagName.toLowerCase();return"script"===n||"style"===n||"noscript"===n||0===t.textContent.trim().length?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let i,l=0;for(;i=r.nextNode();){if(i===o)return l+o.textContent.substring(0,n.startOffset).split(/\s+/).filter(t=>t.length>0).length;l+=i.textContent.split(/\s+/).filter(t=>t.length>0).length}return-1}function l(){const t={text:"",paragraphStarts:[]},e=[];let n=null;const r=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(t){const e=t.parentElement;if(!e)return NodeFilter.FILTER_REJECT;const n=e.tagName.toLowerCase();return"script"===n||"style"===n||"noscript"===n||0===t.textContent.trim().length?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let i;for(o=[0];i=r.nextNode();){const t=i.textContent.split(/\s+/).filter(t=>t.length>0);if(0===t.length)continue;let r=i.parentElement;for(;r&&!["P","H1","H2","H3","H4","H5","H6","LI","ARTICLE","BLOCKQUOTE","DIV","SECTION"].includes(r.tagName);)r=r.parentElement;r&&r!==n&&e.length>0?(o.push(e.length),n=r):n||(n=r),e.push(...t)}return t.text=e.join(" "),t.paragraphStarts=o,t}r.textContent="\n  .flowmate-highlight {\n    background: rgba(231, 76, 60, 0.25) !important;\n    outline: 2px solid rgba(231, 76, 60, 0.8) !important;\n    border-radius: 3px;\n    transition: all 0.15s ease;\n    box-shadow: 0 0 15px rgba(231, 76, 60, 0.3);\n  }\n  .flowmate-highlight-mark {\n    background: linear-gradient(135deg, rgba(231, 76, 60, 0.4), rgba(243, 156, 18, 0.3)) !important;\n    padding: 2px 0;\n    border-radius: 2px;\n  }\n",document.head.appendChild(r),document.addEventListener("contextmenu",t=>{const e=i(t.clientX,t.clientY);if(-1!==e)n=e,console.log("Flow Mate: Right-clicked at word index",e,"word:",(o=e,l().text.split(/\s+/)[o]||"(unknown)"));else{const e=[[0,0],[5,0],[-5,0],[0,5],[0,-5],[10,0],[-10,0]];for(const[o,r]of e){const e=i(t.clientX+o,t.clientY+r);if(-1!==e){n=e,console.log("Flow Mate: Right-clicked near word index",e,"(fallback)");break}}}var o});let a=null;function d(){document.querySelectorAll(".flowmate-highlight").forEach(t=>t.remove()),t=null,e=null,a=-1;try{window.getSelection().removeAllRanges()}catch(t){}}chrome.runtime.onMessage.addListener((r,i,s)=>{if("getContent"===r.action){const t=l();s({content:t.text,paragraphStarts:t.paragraphStarts||o})}else if("getClickedWordIndex"===r.action)s({wordIndex:n});else if("highlight"===r.action){const n=r.text,o=r.index,i=r.wordCount||1;r.contextBefore,r.contextAfter,n&&function(n,o,r,i,l=1){if(n&&!(n.length<1)){d();try{if(void 0!==i&&i>=0){const n=function(t,e){const n=function(){const t=[],e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,{acceptNode:function(t){const e=t.parentElement;if(!e)return NodeFilter.FILTER_REJECT;const n=e.tagName.toLowerCase();return"script"===n||"style"===n||"noscript"===n||0===t.textContent.trim().length?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});let n;for(;n=e.nextNode();){const e=n.textContent,o=/\S+/g;let r;for(;null!==(r=o.exec(e));)t.push({node:n,word:r[0],startOffset:r.index,endOffset:r.index+r[0].length})}return t}();if(t<0||t>=n.length)return null;const o=Math.min(t+e-1,n.length-1),r=n[t],i=n[o];return r&&i?{startNode:r.node,startOffset:r.startOffset,endNode:i.node,endOffset:i.endOffset,sameNode:r.node===i.node}:null}(i,Math.max(1,l));if(n){const o=document.createRange();o.setStart(n.startNode,n.startOffset),o.setEnd(n.endNode,n.endOffset);const r=o.getClientRects();if(r.length>0){const l=n.startNode.parentElement;l&&l.scrollIntoView({behavior:"smooth",block:"center"});for(let e=0;e<r.length;e++){const n=r[e];if(n.width>0&&n.height>0){const o=document.createElement("div");o.className="flowmate-highlight",o.style.cssText=`\n                position: fixed;\n                left: ${n.left-3}px;\n                top: ${n.top-2}px;\n                width: ${n.width+6}px;\n                height: ${n.height+4}px;\n                pointer-events: none;\n                z-index: 999999;\n                background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(243, 156, 18, 0.1));\n                border: 2px solid rgba(231, 76, 60, 0.7);\n                border-radius: 4px;\n                box-shadow: 0 0 12px rgba(231, 76, 60, 0.3);\n              `,document.body.appendChild(o),0===e&&(t=o)}}return e=o,void(a=i)}}}const o=window.getSelection();if(o.removeAllRanges(),window.find(n,!1,!1,!1,!1,!1,!1)){const n=o.getRangeAt(0),r=n.getBoundingClientRect();if(r.width>0&&r.height>0){const o=n.startContainer.parentElement;o&&o.scrollIntoView({behavior:"smooth",block:"center"}),t=document.createElement("div"),t.className="flowmate-highlight",t.style.cssText=`\n          position: fixed;\n          left: ${r.left-3}px;\n          top: ${r.top-2}px;\n          width: ${r.width+6}px;\n          height: ${r.height+4}px;\n          pointer-events: none;\n          z-index: 999999;\n          background: linear-gradient(135deg, rgba(231, 76, 60, 0.15), rgba(243, 156, 18, 0.1));\n          border: 2px solid rgba(231, 76, 60, 0.7);\n          border-radius: 4px;\n          box-shadow: 0 0 12px rgba(231, 76, 60, 0.3);\n        `,document.body.appendChild(t),e=n}setTimeout(()=>o.removeAllRanges(),30)}}catch(t){console.log("Flow Mate: Highlight error",t)}}}(n,0,0,o,i)}else"clearHighlight"===r.action?d():"resetHighlightPosition"===r.action&&(a=-1)})})();