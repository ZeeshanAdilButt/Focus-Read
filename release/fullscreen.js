(()=>{const e=document.getElementById("wordDisplay"),n=document.getElementById("playPauseBtn"),t=document.getElementById("prevBtn"),s=document.getElementById("nextBtn"),c=document.getElementById("exitBtn"),o=document.getElementById("progressBar"),l=document.getElementById("progressText"),u=document.getElementById("wpmDisplay"),r=document.getElementById("timeRemaining");let i,d=[],a=0,m=!1,h=null,g={wpm:300,chunkSize:1,mode:"word",pauses:!0,pauseScale:1.5,focusColor:"#e74c3c",navMode:"seconds",navAmount:10};function p(){document.body.classList.add("show-cursor"),clearTimeout(i),i=setTimeout(()=>{m&&document.body.classList.remove("show-cursor")},2500)}function f(){E(),chrome.runtime.sendMessage({action:"fullscreenClosed",currentIndex:a,wasPlaying:m}),window.close()}function w(e){if(!e)return"&nbsp;";const n=(e=e.trim()).length;if(0===n)return"&nbsp;";let t;t=n<=1?0:n<=5?1:n<=9?2:n<=13?3:4;const s=e.substring(0,t),c=e.charAt(t),o=e.substring(t+1);return`${s}<span class="focus-letter" style="color:${g.focusColor}">${c}</span>${o}`}function k(){if(0===d.length)return void(e.innerHTML='<span class="placeholder">No content</span>');let n="",t=0;if("sentence"===g.mode){e.classList.add("sentence-mode"),e.classList.remove("chunk-mode");let s=a,c=[];for(;s<d.length&&(c.push(d[s]),!(/[.?!]$/.test(d[s])||c.length>30));)s++;n=c.join(" "),t=c.length}else e.classList.remove("sentence-mode"),g.chunkSize>1?e.classList.add("chunk-mode"):e.classList.remove("chunk-mode"),n=d.slice(a,a+g.chunkSize).join(" "),t=g.chunkSize;return n?(e.innerHTML=n.split(/\s+/).filter(e=>e.length>0).map(w).join(" "),{chunk:n,nextIndexChange:t}):(E(),a=0,{chunk:"",nextIndexChange:0})}function y(){if(0===d.length)return;const e=Math.round(a/d.length*100);o.style.width=e+"%",l.textContent=e+"%";const n=(d.length-a)/g.wpm,t=Math.floor(n),s=Math.ceil(60*(n-t));r.textContent=(t>0?`${t}m `:"")+`${s}s`}function L(e){if(!m)return;let n=function(e){const n=6e4/g.wpm;return"sentence"===g.mode?n*e.split(/\s+/).length:n*g.chunkSize}(e);if(g.pauses&&e){const t=e.trim().slice(-1);[".","!","?"].includes(t)?n*=g.pauseScale:[";",":"].includes(t)?n*=1+.7*(g.pauseScale-1):[","].includes(t)&&(n*=1+.4*(g.pauseScale-1))}h=setTimeout(()=>{const n="sentence"===g.mode?e.split(/\s+/).length:g.chunkSize;if(a+=n,a>=d.length)return E(),a=0,k(),void y();const{chunk:t}=k();y(),x(),L(t)},n)}function v(){if(0===d.length)return;m=!0,n.innerHTML='<i class="fas fa-pause"></i>',document.body.classList.remove("show-cursor");const{chunk:e}=k();x(),L(e)}function E(){m=!1,n.innerHTML='<i class="fas fa-play"></i>',document.body.classList.add("show-cursor"),h&&(clearTimeout(h),h=null)}function x(){const e="sentence"===g.mode?15:g.chunkSize;chrome.runtime.sendMessage({action:"highlightFromFullscreen",index:a,wordCount:e,text:d.slice(a,a+e).join(" ")})}function M(e){let n=Math.round(g.wpm/60*10);a=e>0?Math.min(d.length-1,a+n):Math.max(0,a-n),k(),y(),m&&x()}document.addEventListener("mousemove",p),p(),document.addEventListener("DOMContentLoaded",()=>{const n=document.documentElement;n.requestFullscreen?n.requestFullscreen().catch(e=>console.log("Fullscreen error:",e)):n.webkitRequestFullscreen&&n.webkitRequestFullscreen(),chrome.runtime.sendMessage({action:"getFullscreenContent"},n=>{n&&n.words&&n.words.length>0?(d=n.words,a=n.currentIndex||0,g={...g,...n.config},u.textContent=g.wpm+" WPM",k(),y(),n.wasPlaying&&setTimeout(()=>v(),500)):e.innerHTML='<span class="placeholder">No content loaded</span>'})}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement||f()}),n.addEventListener("click",()=>{m?E():v()}),t.addEventListener("click",()=>M(-1)),s.addEventListener("click",()=>M(1)),c.addEventListener("click",()=>{document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),f()}),document.addEventListener("keydown",e=>{" "===e.key||"Space"===e.code?(e.preventDefault(),m?E():v()):"ArrowLeft"===e.key?(e.preventDefault(),M(-1)):"ArrowRight"===e.key?(e.preventDefault(),M(1)):"Escape"===e.key&&f()}),setInterval(()=>{d.length>0&&chrome.runtime.sendMessage({action:"fullscreenSync",currentIndex:a})},1e3)})();