document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("wordDisplay"),t=document.getElementById("playPauseBtn"),n=document.getElementById("prevBtn"),o=document.getElementById("nextBtn"),a=document.getElementById("restartBtn"),s=document.getElementById("wpmInput"),l=document.getElementById("wpmDisplay"),c=document.getElementById("progressBar"),r=document.getElementById("progressText"),i=document.getElementById("timeRemaining"),d=document.getElementById("settingsBtn"),u=document.getElementById("settingsOverlay"),m=document.getElementById("closeSettingsBtn"),g=document.getElementById("chunkSizeInput"),h=document.getElementById("scanPageBtn"),p=document.getElementById("openPdfBtn"),f=document.getElementById("setTextBtn"),v=document.getElementById("clearTextBtn"),E=document.getElementById("manualInputOverlay"),L=document.getElementById("manualTextInput"),y=document.getElementById("loadInputBtn"),B=document.getElementById("cancelInputBtn"),I=document.getElementById("toast"),S=document.getElementById("toastMessage"),k=document.getElementById("fullscreenBtn"),x=(document.getElementById("readerDisplay"),document.getElementById("togglePausesBtn")),M=document.getElementById("toggleLoopBtn"),C=document.getElementById("pauseScaleSlider"),w=document.getElementById("pauseScaleInput"),b=document.getElementById("fontSelect"),T=document.getElementById("fontScaleSlider"),P=document.getElementById("fontScaleInput"),$=document.getElementById("bgColorPicker"),A=document.getElementById("bgColorText"),z=document.getElementById("textColorPicker"),H=document.getElementById("textColorText"),F=document.getElementById("focusColorPicker"),W=document.getElementById("focusColorText"),D=document.getElementById("resetSettingsBtn"),j=document.getElementById("navModeSelect"),O=document.getElementById("navAmountInput");let R=[],q=0,U=!1,N=null,X={wpm:300,chunkSize:1,mode:"word",pauses:!0,loop:!1,pauseScale:1.5,font:"'Segoe UI', sans-serif",fontScale:1,bgColor:"#000000",textColor:"#ffffff",focusColor:"#e74c3c",navMode:"paragraphs",navAmount:1};function G(e,t=2500){I&&S&&(S.textContent=e,I.classList.remove("hidden"),I.offsetHeight,I.classList.add("show"),setTimeout(()=>{I.classList.remove("show"),setTimeout(()=>I.classList.add("hidden"),300)},t))}const J=document.getElementById("modeWordBtn"),K=document.getElementById("modeSentenceBtn"),Q=document.getElementById("chunkSizeContainer");function V(e){if(!e)return"&nbsp;";if(!(e=e.trim()))return"&nbsp;";let t;const n=e.length;t=n<=1||n<=3?0:n<=7?Math.floor(.3*n):Math.floor(.28*n);const o=e.slice(0,t),a=e.slice(t,t+1),s=e.slice(t+1);return`${o}<span class="highlight-char" style="color: ${X.focusColor}">${a}</span>${s}`}function Y(e){return e?e.trim().split(/\s+/).map(e=>V(e)).join(" "):"&nbsp;"}function Z(){document.body.style.backgroundColor=X.bgColor,e.style.color=X.textColor,e.style.fontFamily=X.font;let t=3;if("sentence"===X.mode?t=1.5:X.chunkSize>1&&(t=Math.max(1.5,3-.5*(X.chunkSize-1))),e.style.fontSize=t*X.fontScale+"rem",e.style.whiteSpace="sentence"===X.mode||X.chunkSize>1?"normal":"nowrap",0===R.length)return void(e.innerHTML='<span class="placeholder">Ready to flow</span>');let n="",o=0;if("sentence"===X.mode){let e=q,t=[];for(;e<R.length;){const n=R[e];if(t.push(n),/[.?!]$/.test(n))break;if(t.length>30)break;e++}n=t.join(" "),o=t.length}else n=R.slice(q,q+X.chunkSize).join(" "),o=X.chunkSize;return n?("sentence"===X.mode?e.innerHTML=Y(n):1===X.chunkSize?e.innerHTML=V(n):e.innerHTML=Y(n),{chunk:n,nextIndexChange:o}):X.loop?(q=0,void Z()):(oe(),void(q=0))}function _(){if(0===R.length)return;c.max=R.length,c.value=q;const e=Math.round(q/R.length*100)||0;r.innerText=`${e}%`;const t=(R.length-q)/X.wpm,n=Math.floor(t),o=Math.ceil(60*(t-n));i.innerText=(n>0?`${n}m `:"")+`${o}s`}document.getElementById("sentenceLengthContainer");let ee=1;function te(e){if(!U)return;let t=function(e,t){const n=6e4/X.wpm;return t&&e?n*e.trim().split(/\s+/).length:n*X.chunkSize}(e,"sentence"===X.mode);if(X.pauses&&e){const n=e.trim().slice(-1);[".","!","?"].includes(n)?t*=X.pauseScale:[";",":"].includes(n)?t*=1+.7*(X.pauseScale-1):[","].includes(n)&&(t*=1+.4*(X.pauseScale-1))}N=setTimeout(()=>{!function(){if(!U)return;if(q+=ee,q>=R.length&&!X.loop)return oe(),q=0,void Z();q>=R.length&&X.loop&&(q=0);const{chunk:e,nextIndexChange:t}=Z();ee=t,le(),_(),te(e)}()},t)}function ne(){if(0===R.length)return;U=!0,t.innerHTML='<i class="fas fa-pause"></i>';const e=document.getElementById("fsPlayPause");e&&(e.innerHTML='<i class="fas fa-pause"></i>');const{chunk:n,nextIndexChange:o}=Z();ee=o,le(),te(n)}function oe(){U=!1,t.innerHTML='<i class="fas fa-play"></i>',N&&(clearTimeout(N),N=null)}function ae(e,t=0){e&&(oe(),R=e.trim().split(/\s+/),q=t,ee=1,Z(),_(),le())}function se(){oe(),R=[],q=0,ee=1,e.innerHTML='<span class="placeholder">Ready to flow</span>',c.value=0,r.innerText="0%",i.innerText="--:--",chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&chrome.tabs.sendMessage(e[0].id,{action:"clearHighlight"}).catch(()=>{})})}function le(){if(0===R.length)return;let e="",t="",n="",o=1;if("sentence"===X.mode){let t=q,n=[];for(;t<R.length;){const e=R[t];if(n.push(e),/[.?!]$/.test(e))break;if(n.length>30)break;t++}e=n.join(" "),o=n.length}else e=R.slice(q,q+X.chunkSize).join(" "),o=X.chunkSize;const a=Math.max(0,q-5),s=Math.min(R.length,q+X.chunkSize+5);t=R.slice(a,q).join(" "),n=R.slice(q+X.chunkSize,s).join(" ");const l={action:"highlight",index:q,text:e,wordCount:o,contextBefore:t,contextAfter:n,mode:X.mode};chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&(e[0].url&&e[0].url.startsWith("chrome-extension://")?chrome.runtime.sendMessage(l).catch(()=>{}):chrome.tabs.sendMessage(e[0].id,l).catch(()=>{}))})}function ce(){"sentence"===X.mode?(J.classList.remove("active"),K.classList.add("active"),Q.classList.add("hidden")):(J.classList.add("active"),K.classList.remove("active"),Q.classList.remove("hidden")),s.value=X.wpm,l.innerText=X.wpm,g.value=X.chunkSize,x.classList.toggle("active",X.pauses),x.innerText=X.pauses?"Pauses: On":"Pauses: Off",M.classList.toggle("active",X.loop),M.innerText=X.loop?"Loop: On":"Loop: Off",C.value=X.pauseScale,w.value=X.pauseScale,b.value=X.font,T.value=X.fontScale,P.value=X.fontScale,$.value=X.bgColor,A.value=X.bgColor,z.value=X.textColor,H.value=X.textColor,F.value=X.focusColor,W.value=X.focusColor,j.value=X.navMode,O.value=X.navAmount,ie(),Z()}function re(e,t){X[e]=t,ce()}function ie(){const e={seconds:`${X.navAmount}s`,words:`${X.navAmount} words`,sentences:`${X.navAmount} sentence${X.navAmount>1?"s":""}`,paragraphs:`${X.navAmount} para${X.navAmount>1?"s":""}`};n.title=`Back ${e[X.navMode]}`,o.title=`Forward ${e[X.navMode]}`}async function de(){se();const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t){const n=t.url||"",o=n.toLowerCase().endsWith(".pdf")||n.includes("blob:")||n.includes("/pdf/")||t.title&&t.title.endsWith(".pdf"),a=n.startsWith("chrome-extension://")&&n.includes("viewer.html"),s=n.startsWith("chrome-extension://");if(o&&!a)return void(e.innerHTML='<span class="placeholder">Use PDF button â†’</span>');a||s?chrome.runtime.sendMessage({action:"getContent"},t=>{chrome.runtime.lastError?(console.log("Could not get content from extension page:",chrome.runtime.lastError.message),e.innerHTML='<span class="placeholder">Click Read Page after loading PDF</span>'):t&&t.content?ae(t.content):t&&t.error?(console.log("PDF not ready:",t.error),e.innerHTML='<span class="placeholder">Load a PDF file first</span>'):e.innerHTML='<span class="placeholder">Load a PDF file first</span>'}):chrome.tabs.sendMessage(t.id,{action:"getContent"},t=>{chrome.runtime.lastError?(console.log("Could not auto-load content:",chrome.runtime.lastError.message),e.innerHTML='<span class="placeholder">Reload page</span>'):t&&t.content?(t.paragraphStarts&&(ue=t.paragraphStarts),ae(t.content)):e.innerHTML='<span class="placeholder">No text found</span>'})}}J.addEventListener("click",()=>{X.mode="word",ce()}),K.addEventListener("click",()=>{X.mode="sentence",ce()}),x.addEventListener("click",()=>{X.pauses=!X.pauses,ce()}),M.addEventListener("click",()=>{X.loop=!X.loop,ce()}),C.addEventListener("input",e=>{X.pauseScale=parseFloat(e.target.value),ce()}),w.addEventListener("change",e=>{X.pauseScale=parseFloat(e.target.value),ce()}),T.addEventListener("input",e=>{X.fontScale=parseFloat(e.target.value),ce()}),P.addEventListener("change",e=>{X.fontScale=parseFloat(e.target.value),ce()}),g.addEventListener("change",e=>{X.chunkSize=parseInt(e.target.value)||1,ce()}),b.addEventListener("change",e=>{X.font=e.target.value,ce()}),$.addEventListener("input",e=>re("bgColor",e.target.value)),A.addEventListener("change",e=>re("bgColor",e.target.value)),z.addEventListener("input",e=>re("textColor",e.target.value)),H.addEventListener("change",e=>re("textColor",e.target.value)),F.addEventListener("input",e=>re("focusColor",e.target.value)),W.addEventListener("change",e=>re("focusColor",e.target.value)),D.addEventListener("click",()=>{X={wpm:300,chunkSize:1,mode:"word",pauses:!0,loop:!1,pauseScale:1.5,font:"'Segoe UI', sans-serif",fontScale:1,bgColor:"#000000",textColor:"#ffffff",focusColor:"#e74c3c",navMode:"paragraphs",navAmount:1},ce()}),j.addEventListener("change",e=>{X.navMode=e.target.value,ie()}),O.addEventListener("change",e=>{X.navAmount=parseInt(e.target.value)||1}),ie(),de(),h.addEventListener("click",()=>{de()}),p.addEventListener("click",()=>{const e=chrome.runtime.getURL("viewer.html");chrome.tabs.create({url:e})}),v.addEventListener("click",()=>{se()}),t.addEventListener("click",()=>{U?oe():ne()});let ue=[0];function me(e){let t=0;switch(X.navMode){case"seconds":t=Math.round(X.wpm/60*X.navAmount);break;case"words":t=X.navAmount;break;case"sentences":let n=0,o=q;if(e>0){for(;o<R.length&&n<X.navAmount;)/[.?!]$/.test(R[o])&&n++,o++;t=o-q}else{for(o=Math.max(0,q-1);o>0&&n<X.navAmount;)o--,/[.?!]$/.test(R[o])&&n++;t=q-o}break;case"paragraphs":if(ue.length>1)if(e>0)for(let e=0;e<X.navAmount;e++){let e=ue.find(e=>e>q+t);if(void 0===e){t=R.length-q;break}t=e-q}else{let e=q;for(let t=0;t<X.navAmount;t++){let t=[...ue].reverse().find(t=>t<e);if(void 0===t){e=0;break}e=t}t=q-e}else{const n=5;let o=0,a=q;if(e>0){let e=0;for(;a<R.length&&o<X.navAmount;)/[.?!]$/.test(R[a])&&(e++,e>=n&&(o++,e=0)),a++;t=a-q}else{let e=0;for(a=Math.max(0,q-1);a>0&&o<X.navAmount;)a--,/[.?!]$/.test(R[a])&&(e++,e>=n&&(o++,e=0));t=q-a}}}return Math.max(1,t)}n.addEventListener("click",()=>{const e=me(-1);q=Math.max(0,q-e),Z(),_(),le()}),o.addEventListener("click",()=>{const e=me(1);q=Math.min(R.length-1,q+e),Z(),_(),le()}),a.addEventListener("click",()=>{oe(),q=0,Z(),_()}),s.addEventListener("input",e=>{X.wpm=parseInt(e.target.value),l.innerText=X.wpm}),d.addEventListener("click",()=>{ce(),u.classList.remove("hidden")}),m.addEventListener("click",()=>{u.classList.add("hidden")}),document.getElementById("closeSettingsX").addEventListener("click",()=>{u.classList.add("hidden")}),k.addEventListener("click",function(){if(0===R.length)return;const e=U;U&&oe(),chrome.runtime.sendMessage({action:"openFullscreen",words:R,currentIndex:q,config:{wpm:X.wpm,chunkSize:X.chunkSize,mode:X.mode,pauses:X.pauses,pauseScale:X.pauseScale,focusColor:X.focusColor,navMode:X.navMode,navAmount:X.navAmount},wasPlaying:e})}),chrome.runtime.onMessage.addListener((e,t,n)=>{"syncFromFullscreen"===e.action&&(q=e.currentIndex||0,updateWordDisplay(),_(),updateScrollProgress(),e.wasPlaying&&setTimeout(()=>ne(),300))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(u.classList.add("hidden"),E.classList.add("hidden"))}),f.addEventListener("click",()=>{E.classList.remove("hidden"),L.focus()}),B.addEventListener("click",()=>{E.classList.add("hidden")}),y.addEventListener("click",()=>{const e=L.value;e&&ae(e),E.classList.add("hidden")}),c.addEventListener("input",e=>{const t=U;t&&oe(),q=parseInt(e.target.value),Z(),_(),t&&ne()}),chrome.runtime.onMessage.addListener((e,t,n)=>{if("loadPdfContent"!==e.action){if("contextMenuTriggered"===e.action){const t=e.selectionText?.trim(),n=e.clickedWordIndex??-1;oe(),chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]&&(chrome.tabs.sendMessage(e[0].id,{action:"resetHighlightPosition"}).catch(()=>{}),chrome.tabs.sendMessage(e[0].id,{action:"getContent"},e=>{if(chrome.runtime.lastError||!e?.content)return void(t&&ae(t));const o=e.content.trim().split(/\s+/);e.paragraphStarts&&(ue=e.paragraphStarts);let a=0;if(n>=0&&n<o.length)a=n,console.log("Flow Mate: Starting from clicked word index",a);else if(t){const e=e=>e.toLowerCase().replace(/[^a-z0-9]/g,""),n=t.trim().split(/\s+/).map(e),s=Math.min(3,n.length);for(let t=0;t<o.length-s+1;t++){let l=!0;for(let a=0;a<s;a++)if(e(o[t+a])!==n[a]){l=!1;break}if(l){a=t;break}}}R=o,q=a,ee=1,Z(),_(),G(`Starting from: "${o.slice(a,a+3).join(" ")}..."`),setTimeout(()=>{le()},100)}))})}}else e.content&&(e.paragraphStarts&&(ue=e.paragraphStarts),ae(e.content),G(`Loaded ${R.length.toLocaleString()} words from PDF`))})});
//# sourceMappingURL=sidepanel.js.map